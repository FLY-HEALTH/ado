# fhir-ig-publish-jobs.yml
#
# Description: 
#  

parameters:
  - name: organization
    type: string
  - name: feed
    type: string
  - name: path
    type: string

steps: 
  - powershell: |
      $packages = $(Get-ChildItem -Path ${{ parameters.path }} -Include package.tgz -Recurse -Force).FullName
      foreach($package in $packages){

        # Deal with Folders
        $rootDirectory = [System.IO.Path]::GetFullPath('${{ parameters.path }}')
        $directory = [System.IO.Path]::GetFullPath([System.IO.Path]::GetDirectoryName($package))
        $relativePath = $directory.Replace($rootDirectory,'')

        # Create relative folder
        New-Item -ItemType Directory -Path "$(pipeline.workspace)/.package/$($relativePath)" -Force

        # Extract Package
        tar zxvf $package -C "$(pipeline.workspace)/.package/$($relativePath)"

        # Authenticate
        $npmrc = @() 
        $npmrc += 'registry=https://pkgs.dev.azure.com/${{ parameters.organization }}/_packaging/${{ parameters.feed }}/npm/registry/'
        $npmrc += 'always-auth=true''
        $npmrc += '//pkgs.dev.azure.com/htekdevapps/_packaging/htekdevapps/npm/registry/:_authToken=$(System.AccessToken)' 
        ($npmrc -join "`n") | Set-Content -Path $(pipeline.workspace)/.package/$($relativePath)/.npmrc

        # Publish
        npm publish $(pipeline.workspace)/.package/$($relativePath)
      }
